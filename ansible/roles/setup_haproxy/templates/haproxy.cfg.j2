global
        log /dev/log    local0
        log /dev/log    local1 notice
        chroot /var/lib/haproxy
        stats socket /run/haproxy/admin.sock mode 660 level admin
        stats timeout 30s
        user haproxy
        group haproxy
        daemon

        # Default SSL material locations & please copy your self-signed ca.crt's to /usr/local/share/ca-certificates
        ca-base /etc/ssl/certs
        crt-base /etc/ssl/private

        # See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        timeout connect 10000
        timeout client  10000
        timeout server  10000

resolvers internal
  nameserver home {{ setupinfos.local_dns }}:53

frontend stats
  mode http
  bind :8080
  stats enable
  stats refresh 10s
  stats uri /stats
  stats show-modules

frontend gateway_01
  bind {{ hostinfos[ansible_mutated_host].wireguard_ip }}:443 ssl crt {{setupinfos.lb_cert_dir}}/public-server-bundle.pem
  mode http
  maxconn {{ setupinfos.max_connections_haproxy }}
  timeout client 10000
{% for DOM in setupinfos.haproxy_domains %}
{% if DOM.state == "down" %}
  #acl acl_{{DOM.domain}} hdr(host) -i {{DOM.domain}}.{{setupinfos.external_domain}} #state:{{DOM.state}}
  #use_backend be_{{DOM.domain}} if acl_{{DOM.domain}}
{% else %}
  acl acl_{{DOM.domain}} hdr(host) -i {{DOM.domain}}.{{setupinfos.external_domain}} #state:{{DOM.state}}
  use_backend be_{{DOM.domain}} if acl_{{DOM.domain}}
{% endif %}
{% endfor %}
  default_backend be_default

frontend gateway_02
  bind :443 ssl crt {{setupinfos.lb_cert_dir}}/private-server-bundle.pem
  stick-table  type ipv6  size 100k  expire 30s  store http_req_rate(10s)
  http-request track-sc0 src
  http-request deny deny_status 429 if { sc_http_req_rate(0) gt 80 }
  mode http
  maxconn {{ setupinfos.max_connections_haproxy }}
  timeout client 10000
{% for HD in vault.haproxy.hidden_domains %}
{% if HD.state == "down" %}
  #acl acl_{{HD.domain}} hdr(host) -i {{HD.domain}}.{{setupinfos.internal_domain}} #state:{{HD.state}}
  #use_backend be_h_{{HD.domain}} if acl_{{HD.domain}}
{% else %}
  acl acl_{{HD.domain}} hdr(host) -i {{HD.domain}}.{{setupinfos.internal_domain}} #state:{{HD.state}}
  use_backend be_h_{{HD.domain}} if acl_{{HD.domain}}
{% endif %}
{% endfor %}
  default_backend be_default

frontend k8s_api
  bind :6443
  mode tcp
  default_backend be_k8s_api

{% for DO in setupinfos.haproxy_domains %}
backend be_{{DO.domain}}
  mode http
  http-request set-header Host {{DO.domain}}.{{setupinfos.internal_domain}}
{% for DBI in DO.ip %}
  server srv{{loop.index0}} {{DBI}} ssl verify required ca-file {{setupinfos.lb_cert_dir}}/private-ca-bundle.crt check resolvers internal
{% endfor %}
{% endfor %}

{% for HDB in vault.haproxy.hidden_domains %}
backend be_h_{{HDB.domain}}
  mode http
{% if HDB.chk == "httpchk-200" %}
  option httpchk
  http-check expect status 200
{% endif %}
  http-request set-header Host {{HDB.domain}}.{{setupinfos.internal_domain}}
{% if HDB.origin == "yes" %}
  http-request set-header Origin https://{{HDB.domain}}.{{setupinfos.internal_domain}}
{% endif %}
{% if HDB.ip[0] == "default" %}
{% for HDBD in setupinfos.k3s.ingress_nodes %}
  server srv{{loop.index0}} {{HDBD}}:443 ssl verify required ca-file {{setupinfos.lb_cert_dir}}/private-ca-bundle.crt check resolvers internal
{% endfor %}
{% else %}
{% for HDBI in HDB.ip %}
  server srv{{loop.index0}} {{HDBI}} ssl verify required ca-file {{setupinfos.lb_cert_dir}}/private-ca-bundle.crt check resolvers internal
{% endfor %}
{% endif %}
{% endfor %}

backend be_default
  mode http
  http-request set-header Host m0rpheus.ch
  server ngx 127.0.0.1:444 ssl verify required ca-file {{setupinfos.lb_cert_dir}}/public-ca-bundle.crt

backend be_k8s_api
  mode tcp
  tcp-check set-var(check.port) int(6443)
  tcp-check connect port var(check.port)
{% for HOST in groups["hl_master"] %}
  server m{{loop.index0}} {{HOST}}:6443 check resolvers internal
{% endfor %}
